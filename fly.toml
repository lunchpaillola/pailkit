# fly.toml app configuration file for PailKit
#
# This configuration deploys the Flow service which includes all API routes.
# All routes (bot, rooms, transcribe, workflows, webhooks) are in flow/main.py.
#
# This is the main HTTP service that handles API requests. When bots are enabled,
# they can be spawned as separate Fly.io machines (see bot_service.py) for better
# performance and isolation. Each bot gets its own dedicated resources.
#
# See https://fly.io/docs/reference/configuration/ for information about how to use this file.
#

app = "pailkit-api"
primary_region = "iad"

[build]
  # Dockerfile is at project root - builds both API and Flow together
  # Uses Python 3.12 as specified in Dockerfile
  dockerfile = "Dockerfile"

[env]
  PORT = "8080"
  # Set FLY_APP_NAME to match the app name for bot machine spawning
  FLY_APP_NAME = "pailkit-api"

# VM configuration for the HTTP service (API server)
# This configures the main API server machine. Bot machines are spawned separately
# with their own resources (1GB RAM, 1 CPU) as configured in bot_service.py.
# Increased to 1GB to handle concurrent bot spawn requests better.
[vm]
  memory_mb = 1024
  cpu_kind = "shared"
  cpus = 1

# Persistent volume for SQLite database (flow/pailflow.db)
# The database will be stored at /data/pailflow.db and persist across deployments
# Note: 1GB is the minimum size for Fly.io volumes, but it's very cheap (~$0.15/month)
# For a SQLite database storing session data, 1GB is plenty and you can resize later if needed
# To create the volume: fly volumes create pailflow_data --size 1
[[mounts]]
  source = "pailflow_data"
  destination = "/data"

[http_service]
  internal_port = 8080
  force_https = true
  auto_stop_machines = true
  auto_start_machines = true
  min_machines_running = 1
  processes = ["app"]
